"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),n=e(require("gulp")),r=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),i=e(require("gulp-load-plugins")),p=e(require("vue-template-compiler")),o=e(require("preprocess")),c=e(require("fs-extra")),l=e(require("chokidar")),u=e(require("strip-json-comments")),g=e(require("gulp-strip-comments"));const{program:f}=a;f.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),f.parse(process.argv);const h={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json"}},m=h[f.type];if(!m)throw Error("小程序类型错");process.env.PACK_TYPE=f.type;const d=f.scope,P=function(){return require.apply(null,arguments)}(r.resolve(d,"./projectToSubPackageConfig")),y=P.sourceCodePath||"src",b=P.wxResourcePath||`${y}/${m.globalObject}resource`,v=P.wxResourceAlias||"@wxResource",w=RegExp(v+"\\/","g"),j=P.uniRequireApiName||"__uniRequireWx",k=RegExp(j+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),x=P.uniImportWxssApiName||"__uniWxss",$=RegExp(`(}|^|\\s|;)${x}\\s*{([^{}]+)}`,"g"),S=P.projectConfigPath||"";let O="dev";"production"===process.env.NODE_ENV&&(O="build");const _="dist/"+O+"/mp-"+f.type;let E="dist/"+O+`/mp-${f.type}-pack`;f.plugin&&(E="dist/"+O+`/mp-${f.type}-pack-plugin`);var C={pluginProcessFileTypes:P.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:m,program:f,cwd:d,projectToSubPackageConfig:P,wxResourcePath:b,wxResourceAlias:v,regExpWxResources:w,uniRequireApiName:j,regExpUniRequire:k,uniImportWxssApiName:x,regExpUniImportWxss:$,configWxResourceKey:P.configWxResourceKey||"wxResource",env:O,base:_,target:E,basePath:r.resolve(d,_),subModePath:r.resolve(d,E,P.subPackagePath),targetPath:r.resolve(d,E),packIsSubpackage:{mode:!1},mpTypeNamespace:h,sourceCodePath:y,projectConfigPath:S};let A;const N=s.stdout;var R={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){N(e),clearTimeout(A),A=setTimeout(()=>{N("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,n,r,a){n&&(n(t,r,a),t.childNodes?t.childNodes.forEach((t,r,a)=>{e(t,n,r,a)}):t.children&&t.children.forEach((t,r,a)=>{e(t,n,r,a)}))}};const{basePath:M}=C,{tryAgain:T}=R;n.task("clean:base",(async function e(n){try{await t([M+"/**/*"],{force:!0})}catch(t){return void await T(async()=>{await e(n)})}n()}));const{subModePath:L}=C,{tryAgain:B}=R;n.task("clean:subModePath",(async function e(n){try{await t([L+"/**/*"],{force:!0})}catch(t){return void await B(async()=>{await e(n)})}n()}));const{targetPath:q}=C,{tryAgain:F}=R;n.task("clean:previewDist",(async function e(n){try{await t([q+"/**/*"],{force:!0})}catch(t){return void await F(async()=>{await e(n)})}n()}));const{compile:J}=p;var W=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=J(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,n){if(!e.attrsMap)return"";e.attrsMap[t]=n}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:n,attrsMap:r,children:a=[]}=t;return e+=this.writeOpenTag(n,r),e+=this.render(a),e+=this.writeCloseTag(n)},t)}writeOpenTag(e,t){if(t){const n=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${n.length>0?" "+n.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:I,mpTypeNamespace:U}=C,{deepFind:K}=R,D=Object.keys(U).map(e=>U[e].directivePrefix),H=Object.keys(U).map(e=>U[e].html),Y=RegExp(`^(${D.join("|")})`),z=RegExp(`\\.(${H.join("|")})$`,"i");var V=function(e,t){if(t.relative.match(z)){const t=new W(e);return K(t.topNode,e=>{if(!e.tag||3===e.type)return;const n=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&n&&!n.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",n+" ");const r=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&r&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",r);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(z,"."+I.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(Y)){const n=t.replace(Y,I.directivePrefix);e.attrsMap[n]=e.attrsMap[t],n!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:Z,mpTypeNamespace:G}=C,Q=Object.keys(G).map(e=>G[e].css),X=RegExp(`\\.(${Q.join("|")})$`,"i");var ee=function(e,{relative:t}){return t.match(X)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(X,"."+Z.css)}'`}))),e};var te=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:ne}=o;var re=function(e,{relative:t}){if(t.match(/\.js$/i))try{return ne(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:ae}=C,{preprocess:se}=o;var ie=function(e,{relative:t}){if(t.match(RegExp(`.${ae.css}$`,"i")))try{return se(e,process.env,{type:"css"})}catch(t){return console.log(ae.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:pe}=C,{preprocess:oe}=o;var ce=function(e,{relative:t}){if(t.match(RegExp(`.${pe.html}$`,"i")))try{return oe(e,process.env,{type:"html"})}catch(t){return console.log(pe.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:le,currentNamespace:ue}=C,ge=(process,new Set(Object.keys(le).map(e=>le[e].globalObject)));var fe={mixinsEnvCode:function(e){let t="";return ge.forEach(e=>{ue.globalObject!==e&&(t+=`var ${e} = ${ue.globalObject};\n`)}),t}};const{mixinsEnvCode:he}=fe;var me={htmlMixinPlugin:V,cssMixinPlugin:ee,polyfillPlugin:te,jsPreProcessPlugin:re,cssPreProcessPlugin:ie,htmlPreProcessPlugin:ce,jsMixinPlugin:function(e,{relative:t}){return t.match(/\.js$/i)?he()+e:e}};const{projectToSubPackageConfig:de,targetPath:Pe}=C,ye=r;(!de.plugins||!de.plugins instanceof Array)&&(de.plugins=[]);var be={runPlugins:function(e){return function(t){const{plugins:n}=de;if(n&&!(!n instanceof Array))return n.reduce((t,n)=>{if("string"==typeof n&&(n=me[n]),"function"!=typeof n)return t;const r=ye.resolve(e,this.file.relative),a={relative:r.replace(RegExp("^"+Pe.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:r};this.removeAfterAdd=function(e){!function(e){c.existsSync(e)&&c.removeSync(e);const t=l.watch(e);t.on("add",(function(){c.removeSync(e),t.close()}))}(e=e||r)};const s=n.call(this,t,a,me);return null==s?t:s},t)}}};const ve=i(),{cwd:we,projectToSubPackageConfig:je,target:ke,env:xe,pluginProcessFileTypes:$e,sourceCodePath:Se}=C,{writeLastLine:Oe}=R,{runPlugins:_e}=be;n.task("watch:pluginJson",(function(){const e=ve.filter($e.map(e=>"**/*."+e),{restore:!0});return n.src(Se+"/plugin.json",{allowEmpty:!0,cwd:we}).pipe(ve.if("dev"===xe,ve.watch(Se+"/plugin.json",{cwd:we},(function(e){Oe("处理"+e.relative+"......")})))).pipe(e).pipe(ve.replace(/[\s\S]*/,_e(r.resolve(we,ke+"/"+je.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(ke+"/"+je.subPackagePath,{cwd:we}))}));const Ee=i(),{cwd:Ce,target:Ae,env:Ne,targetPath:Re,pluginProcessFileTypes:Me,currentNamespace:Te,projectConfigPath:Le}=C,{writeLastLine:Be}=R,{runPlugins:qe}=be;n.task("watch:projectConfigJson",(function(){const e=Ee.filter(Me.map(e=>"**/*."+e),{restore:!0});return n.src(`${Le?Le+"/":""}${Te.projectConfig}`,{allowEmpty:!0,cwd:Ce}).pipe(Ee.if("dev"===Ne,Ee.watch(`${Le?Le+"/":""}${Te.projectConfig}`,{cwd:Ce},(function(e){Be("处理"+e.relative+"......")})))).pipe(e).pipe(Ee.replace(/[\s\S]*/,qe(Re),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(Ae,{cwd:Ce}))}));const{program:Fe,cwd:Je,projectToSubPackageConfig:We,basePath:Ie,subModePath:Ue,targetPath:Ke,packIsSubpackage:De,currentNamespace:He}=C;var Ye=function(){if(Fe.plugin)return;const e=r.resolve(Je,We[He.mainMpPath]+"/app.js");if(c.existsSync(e)){const t=c.readFileSync(e,"utf8");let n=`require('${`./${We.subPackagePath}/`}app.js');\n`;if(Ue===Ke){n=c.readFileSync(Ie+"/app.js","utf8")+";\n"}(De.mode||Fe.plugin)&&(n=""),c.outputFileSync(Ke+"/app.js",n+t)}};const ze=i(),{program:Ve,cwd:Ze,projectToSubPackageConfig:Ge,configWxResourceKey:Qe,base:Xe,packIsSubpackage:et,currentNamespace:tt,sourceCodePath:nt}=C,{writeLastLine:rt}=R;var at=function(e){return rt("处理app.json......"),ze.replace(/[\s\S]+/,(function(t){if(Ve.plugin&&"mainAppJson"===e)return t;et.mode=!1;let n,a,s,i={};({pagesJson(){try{n=JSON.parse(u(t))}catch(e){n={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{n||(n=JSON.parse(u(c.readFileSync(r.resolve(Ze,nt+"/pages.json"),"utf8"))))}catch(e){n={}}try{a||(a=JSON.parse(c.readFileSync(r.resolve(Ze,Xe+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(c.readFileSync(r.resolve(Ze,Ge[tt.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function p(e){return Ge.subPackagePath+(Ge.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===Ge.subPackagePath);if(e){et.mode=!0;let t=[...n[Qe]&&n[Qe].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),n[Qe]&&n[Qe].subPackages&&n[Qe].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Ye(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=p(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=p(e.root)}),n[Qe]&&(n[Qe].pages&&n[Qe].pages.forEach((e,t)=>{n[Qe].pages[t]=p(e)}),n[Qe].subPackages&&n[Qe].subPackages.forEach(e=>{e.root=p(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:n,...r},s)=>{a.tabBar.list[s]={pagePath:e?p(e):"",iconPath:t?p(t):"",selectedIconPath:n?p(n):"",...r}}),i={...a,...s},i.pages=Array.from(new Set([...n.indexPage?[p(n.indexPage)]:[],...s.pages||[],...a.pages||[],...n[Qe]&&n[Qe].pages||[]]));let o=[],l={};function g(e){e.forEach(e=>{l[e.root]=l[e.root]?Array.from(new Set([...l[e.root],...e.pages])):e.pages})}g(n[Qe]&&n[Qe].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in l)o.push({root:e,pages:l[e]});if(i.subPackages=[...o],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+Ge.subPackagePath+a.usingComponents[e];i.usingComponents={...i.usingComponents||{},...a.usingComponents}}return Ye(),"toutiao"===Ve.type&&i.subPackages&&(i.subPackages.forEach(e=>{e.pages.forEach(t=>{i.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete i.subPackages),JSON.stringify(i,null,2)}),{skipBinary:!1})};const st=i(),{cwd:it,target:pt,env:ot,targetPath:ct,pluginProcessFileTypes:lt,sourceCodePath:ut}=C,{writeLastLine:gt}=R,{runPlugins:ft}=be;n.task("watch:pagesJson",(function(){const e=st.filter(lt.map(e=>"**/*."+e),{restore:!0});return n.src(ut+"/pages.json",{allowEmpty:!0,cwd:it}).pipe(st.if("dev"===ot,st.watch(ut+"/pages.json",{cwd:it},(function(e){gt("处理"+e.relative+"......")})))).pipe(at("pagesJson")).pipe(st.rename("app.json")).pipe(e).pipe(st.replace(/[\s\S]*/,ft(ct),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(pt,{cwd:it}))}));const ht=i(),{cwd:mt,target:dt,env:Pt,base:yt,targetPath:bt,pluginProcessFileTypes:vt}=C,{writeLastLine:wt}=R,{runPlugins:jt}=be;n.task("watch:baseAppJson",(function(){const e=ht.filter(vt.map(e=>`${yt}/**/*.${e}`),{restore:!0});return n.src(yt+"/app.json",{allowEmpty:!0,cwd:mt}).pipe(ht.if("dev"===Pt,ht.watch(yt+"/app.json",{cwd:mt},(function(e){wt("处理"+e.relative+"......")})))).pipe(at("baseAppJson")).pipe(e).pipe(ht.replace(/[\s\S]*/,jt(bt),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(dt,{cwd:mt}))}));const kt=i(),{cwd:xt,target:$t,env:St,projectToSubPackageConfig:Ot,program:_t,currentNamespace:Et,pluginProcessFileTypes:Ct}=C,{writeLastLine:At}=R,{runPlugins:Nt}=be;n.task("watch:mainAppJson",(function(){const e=Ot[Et.mainMpPath],t=kt.filter(Ct.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src(e+"/app.json",{allowEmpty:!0,cwd:xt}).pipe(kt.if("dev"===St,kt.watch(e+"/app.json",{cwd:xt},(function(e){At("处理"+e.relative+"......")})))).pipe(at("mainAppJson")).pipe(t).pipe(kt.replace(/[\s\S]*/,Nt(r.resolve(xt,$t+(_t.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(n.dest($t+(_t.plugin?"/miniprogram":""),{cwd:xt}))}));const Rt=i(),{cwd:Mt,target:Tt,env:Lt,projectToSubPackageConfig:Bt,program:qt,basePath:Ft,currentNamespace:Jt,mpTypeNamespace:Wt,pluginProcessFileTypes:It}=C,{writeLastLine:Ut}=R,{runPlugins:Kt}=be;n.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=Bt[Jt.mainMpPath];const t=Object.keys(Wt).map(t=>`${e}/app.${Wt[t].css}`),a=Rt.filter([...t],{restore:!0}),s=Rt.filter([e+"/app.js"],{restore:!0}),i=Rt.filter(It.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/app.js",...t],{allowEmpty:!0,cwd:Mt}).pipe(Rt.if("dev"===Lt,Rt.watch([e+"/app.js",`${e}/app.${Jt.css}`],{cwd:Mt},(function(e){Ut("处理"+e.relative+"......")})))).pipe(s).pipe(Rt.replace(/^/,(function(e){return c.readFileSync(Ft+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(Rt.replace(/^/,(function(e){return c.readFileSync(`${Ft}/app.${Jt.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(Rt.rename((function(e){e.extname="."+Jt.css}))).pipe(a.restore).pipe(i).pipe(Rt.replace(/[\s\S]*/,Kt(r.resolve(Mt,Tt+(qt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(i.restore).pipe(n.dest(Tt+(qt.plugin?"/miniprogram":""),{cwd:Mt}))}));const Dt=i(),{cwd:Ht,target:Yt,env:zt,projectToSubPackageConfig:Vt,base:Zt,wxResourcePath:Gt,currentNamespace:Qt,mpTypeNamespace:Xt,pluginProcessFileTypes:en}=C,{writeLastLine:tn}=R,{runPlugins:nn}=be;n.task("watch:mainWeixinMpPackPath",(function(){const e=Vt[Qt.mainMpPath],a=e+"/"+Vt.subPackagePath,s=Yt+"/"+Vt.subPackagePath,i=[],p=[],o=new Set,l=new Set;Object.keys(Xt).forEach(e=>{i.push(`${a}/**/*.${Xt[e].css}`),p.push(`${a}/**/*.${Xt[e].html}`),o.add("."+Xt[e].css),l.add("."+Xt[e].html)});const u=Dt.filter([...p],{restore:!0}),g=Dt.filter([...i],{restore:!0}),f=(Dt.filter([a+"/**/*.js"],{restore:!0}),Dt.filter(en.map(e=>`${a}/**/*.${e}`),{restore:!0}));return n.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Ht}).pipe(Dt.if("dev"===zt,Dt.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Ht},(function(e){tn("处理"+e.relative+"......")})))).pipe(Dt.filter((function(n){if(n.relative!==Qt.projectConfig&&!function(e){const t=Vt[Qt.mainMpPath]+"/"+Vt.subPackagePath;return c.existsSync(e.path.replace(r.resolve(Ht,t),r.resolve(Ht,Zt)))?["ext.json",Qt.projectConfig].indexOf(e.relative)>-1&&Vt.mergePack&&""===Vt.subPackagePath:!c.existsSync(e.path.replace(r.resolve(Ht,t),r.resolve(Ht,Gt)))}(n))return!1;if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");o.has(n.extname)&&(a=a.replace(s,"."+Qt.css)),l.has(n.extname)&&(a=a.replace(s,"."+Qt.html)),t.sync([a.replace(r.resolve(Ht,e),r.resolve(Ht,Yt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(Dt.rename((function(e){e.extname="."+Qt.html}))).pipe(u.restore).pipe(g).pipe(Dt.rename((function(e){e.extname="."+Qt.css}))).pipe(g.restore).pipe(f).pipe(Dt.replace(/[\s\S]*/,nn(r.resolve(Ht,s)),{skipBinary:!1})).pipe(f.restore).pipe(n.dest(s,{cwd:Ht}))}));const rn=i(),{cwd:an,target:sn,env:pn,projectToSubPackageConfig:on,basePath:cn,subModePath:ln,targetPath:un,program:gn,packIsSubpackage:fn,currentNamespace:hn,mpTypeNamespace:mn,pluginProcessFileTypes:dn}=C,{writeLastLine:Pn}=R,{runPlugins:yn}=be;n.task("watch:mainWeixinMp",(function(){const e=on[hn.mainMpPath],a=e+"/"+on.subPackagePath,s=[],i=[],p=new Set,o=new Set;Object.keys(mn).forEach(t=>{s.push(`${e}/**/*.${mn[t].css}`),i.push(`${e}/**/*.${mn[t].html}`),p.add("."+mn[t].css),o.add("."+mn[t].html)});const c=rn.filter([e+"/app.js"],{restore:!0}),l=(rn.filter([e+"/**/*.js"],{restore:!0}),rn.filter([...i],{restore:!0})),u=rn.filter([...s],{restore:!0}),g=rn.filter(dn.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${hn.html}___jb_tmp___`,"!"+e+`/**/*.${hn.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:r.resolve(an,e),allowEmpty:!0,cwd:an}).pipe(rn.if("dev"===pn,rn.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:an},(function(e){e.relative.match(/.json/),Pn("处理"+e.relative+"......")})))).pipe(rn.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");p.has(n.extname)&&(a=a.replace(s,"."+hn.css)),o.has(n.extname)&&(a=a.replace(s,"."+hn.html)),t.sync([a.replace(r.resolve(an,e),r.resolve(an,sn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(c).pipe(rn.replace(/[\s\S]*/,(function(e){if(fn.mode||gn.plugin)return e;let t=`./${on.subPackagePath}/`;if(ln===un){const t=fs.readFileSync(cn+"/app.js","utf8");return e.match(RegExp(t.replace(/\./g,"\\.").replace(/\(/g,"\\(").replace(/\)/g,"\\)")))?e:`${t};\n${e}`}return e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}app.js');\n${e}`}),{skipBinary:!1})).pipe(c.restore).pipe(l).pipe(rn.rename((function(e){e.extname="."+hn.html}))).pipe(l.restore).pipe(u).pipe(rn.rename((function(e){e.extname="."+hn.css}))).pipe(u.restore).pipe(g).pipe(rn.replace(/[\s\S]*/,yn(r.resolve(an,sn+(gn.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(g.restore).pipe(n.dest(sn+(gn.plugin?"/miniprogram":""),{cwd:an}))}));var bn={fakeUniBootstrap:function(e,t,n,r){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:r}),globalObject.onAppHide&&globalObject.onAppShow||(n="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==n||globalObject.onAppRoute||(n="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==n){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(r){"top"!==n&&0!==("/"+r.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=r.path})),globalObject.onAppHide((function(r){if("top"===n)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,r);var a=getCurrentPages();return 0===("/"+(null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===n&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===n&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(r){if("top"!==n){var a=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var n=getCurrentPages(),r=null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+r).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const vn=i(),{regExpWxResources:wn,regExpUniRequire:jn}=C,{getLevelPath:kn,getLevel:xn}=R;var $n={uniRequireWxResource:function(){return vn.replace(/[\s\S]*/,(function(e,t){const n=["var __uniPackNativeRequireInject={};\n"],r=xn(this.file.relative);return e=e.replace(jn,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(wn,kn(r))})`);const a=t.replace(wn,kn(r)),s=`__uniPackNativeRequireInject[${a}] = require(${a});\n`;return 0>n.indexOf(s)&&n.push(s),`__uniPackNativeRequireInject[${a}]`}),n[1]?`${n.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:Sn,regExpWxResources:On,wxResourceAlias:_n}=C,{getLevelPath:En,getLevel:Cn}=R;var An=function(e,t){const n=Cn(t);return"@import "+`"${_n}/common/main.${Sn.css}";`.replace(On,En(n))+("\n"+e)};const Nn=i(),{fakeUniBootstrapName:Rn,fakeUniBootstrap:Mn}=bn,{cwd:Tn,env:Ln,program:Bn,basePath:qn,targetPath:Fn,subModePath:Jn,base:Wn,regExpUniRequire:In,regExpWxResources:Un,regExpUniImportWxss:Kn,currentNamespace:Dn,mpTypeNamespace:Hn,pluginProcessFileTypes:Yn,sourceCodePath:zn,projectToSubPackageConfig:Vn}=C,Zn=process.env.PACK_TYPE,{writeLastLine:Gn,getLevel:Qn,getLevelPath:Xn,deepFind:er}=R,{uniRequireWxResource:tr}=$n,{runPlugins:nr}=be,rr=Object.keys(Hn).map(e=>Hn[e].css),ar=new Set(rr);n.task("subMode:createUniSubPackage",(function(){c.mkdirsSync(qn);const e=Nn.filter(Wn+"/**/*.js",{restore:!0}),a=Nn.filter([Wn+"/common/vendor.js"],{restore:!0}),s=Nn.filter([Wn+"/common/main.js"],{restore:!0}),i=Nn.filter(Yn.map(e=>`${Wn}/**/*.${e}`),{restore:!0}),p=Nn.filter([Wn+"/**/*.js","!"+Wn+"/app.js","!"+Wn+"/common/vendor.js","!"+Wn+"/common/main.js","!"+Wn+"/common/runtime.js"],{restore:!0}),o=Nn.filter([`${Wn}/**/*.${Dn.css}`,`!${Wn}/app.${Dn.css}`,`!${Wn}/common/main.${Dn.css}`],{restore:!0}),l=Nn.filter([`${Wn}/**/*.${Dn.css}`,`!${Wn}/app.${Dn.css}`],{restore:!0}),u=Nn.filter([Wn+"/**/*.json"],{restore:!0}),f=Nn.filter([`${Wn}/**/*.${Dn.html}`],{restore:!0});return n.src([Wn+"/**","!"+Wn+"/app.json",Wn+"/app.js",`${Wn}/app.${Dn.css}`],{allowEmpty:!0,cwd:Tn}).pipe(Nn.if("dev"===Ln,Nn.watch([Wn+"/**/*","!/"+Wn+"/app.json"],{cwd:Tn},(function(e){Gn("处理"+e.relative+"......")})))).pipe(Nn.filter((function(e){if(function(e){const t=r.resolve(Fn,"app.js"),n=r.resolve(Fn,"app."+Dn.css),a=e.path.replace(qn,Jn);return t===a||n===a}(e))return!1;if(function(e){if(0>["ext.json",Dn.projectConfig].indexOf(e.relative))return!1;if(Vn.mergePack&&""===Vn.subPackagePath){if(c.existsSync(r.resolve(Tn,Vn[Dn.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");ar.has(e.extname.substr(1))&&(n=n.replace(a,"."+Dn.css)),t.sync([n.replace(qn,r.resolve(Tn,Jn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(Nn.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(Dn.html+"$","i"),Dn.css),n=this.file.relative.replace(RegExp(Dn.html+"$","i"),Dn.css);c.existsSync(t)||c.outputFileSync(r.resolve(Tn,Jn,n),An("",n));const a=new W(e);let s=0;return er(a.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(In,(t,n,r,a)=>{const i=Qn(this.file.relative),p=n.replace(Un,Xn(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],s=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),s?a.render():e}),{skipBinary:!1})).pipe(f.restore).pipe(a).pipe(Nn.replace(/^/,(function(e){return Bn.plugin?`var App=function(packInit){};${Dn.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${Rn}=${(""+Mn).replace(/globalObject/g,Dn.globalObject)};${Rn}(packInit,__packConfig.packPath,__packConfig.appMode,'${Zn}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(g()).pipe(tr()).pipe(e.restore).pipe(s).pipe(Nn.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(Nn.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(p).pipe(Nn.replace(/^/,(function(e){if(c.existsSync(r.resolve(Tn,zn,this.file.relative)))return e;return`require('${Xn(Qn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(p.restore).pipe(u).pipe(Nn.replace(/[\s\S]*/,(function(e){if(!c.existsSync(r.resolve(Tn,zn,this.file.relative.replace(/json$/,"vue")))&&!c.existsSync(r.resolve(Tn,zn,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Xn(Qn(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(u.restore).pipe(l).pipe(Nn.stripCssComments()).pipe(Nn.replace(Kn,(function(e,t,n){let r="",a=Qn(this.file.relative);return(n+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const n=RegExp(`(${rr.join("|")})(['"])$`);t=t.replace(n,Dn.css+"$2"),r+=`@import ${t.replace(Un,Xn(a))};\n`})),t+r}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(Nn.stripCssComments()).pipe(Nn.replace(/^[\s\S]*$/,(function(e){return Jn===Fn?e:An(e,this.file.relative)}),{skipBinary:!1})).pipe(o.restore).pipe(i).pipe(Nn.replace(/[\s\S]*/,nr(Jn),{skipBinary:!1})).pipe(i.restore).pipe(n.dest(Jn,{cwd:Tn}))}));const sr=i(),{cwd:ir,env:pr,targetPath:or,subModePath:cr,regExpWxResources:lr,regExpUniImportWxss:ur,wxResourcePath:gr,currentNamespace:fr,mpTypeNamespace:hr,pluginProcessFileTypes:mr}=C,{writeLastLine:dr,getLevel:Pr,getLevelPath:yr}=R,{uniRequireWxResource:br}=$n,{runPlugins:vr}=be,wr=[],jr=[],kr=[],xr=new Set,$r=new Set;Object.keys(hr).forEach(e=>{wr.push(hr[e].css),jr.push(`${gr}/**/*.${hr[e].css}`),kr.push(`${gr}/**/*.${hr[e].html}`),xr.add("."+hr[e].css),$r.add("."+hr[e].html)}),n.task("subMode:copyWxResource",(function(){const e=sr.filter([gr+"/**/*.js"],{restore:!0}),a=sr.filter([...jr],{restore:!0}),s=sr.filter([...kr],{restore:!0}),i=sr.filter(mr.map(e=>`${gr}/**/*${e}`),{restore:!0});return n.src([gr+"/**",gr],{allowEmpty:!0,cwd:ir}).pipe(sr.if("dev"===pr,sr.watch([gr+"/**",gr,`!/${gr}/**/*.*___jb_tmp___`],{cwd:ir},(function(e){dr("处理"+e.relative+"......")})))).pipe(e).pipe(sr.replace(/^/,(function(e){return`require('${yr(Pr(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(g()).pipe(br()).pipe(e.restore).pipe(a).pipe(sr.stripCssComments()).pipe(sr.replace(ur,(function(e,t,n){let r="";Pr(this.file.relative);return t+r}),{skipBinary:!1})).pipe(sr.replace(/^[\s\S]*$/,(function(e){return cr===or?e:An(e,this.file.relative)}),{skipBinary:!1})).pipe(sr.rename((function(e){e.extname="."+fr.css}))).pipe(a.restore).pipe(s).pipe(sr.rename((function(e){e.extname="."+fr.html}))).pipe(s.restore).pipe(sr.filter((function(e){if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");xr.has(e.extname)&&(n=n.replace(a,"."+fr.css)),$r.has(e.extname)&&(n=n.replace(a,"."+fr.html)),t.sync([n.replace(r.resolve(ir,gr),r.resolve(ir,cr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(sr.replace(/[\s\S]*/,vr(cr),{skipBinary:!1})).pipe(i.restore).pipe(n.dest(cr,{cwd:ir}))}));const Sr=i(),{cwd:Or,target:_r,env:Er,projectToSubPackageConfig:Cr,currentNamespace:Ar,mpTypeNamespace:Nr,pluginProcessFileTypes:Rr}=C,{writeLastLine:Mr}=R,{runPlugins:Tr}=be;n.task("watch:native",(function(){const e=Cr[Ar.mainMpPath],a=[],s=[],i=new Set,p=new Set;Object.keys(Nr).forEach(t=>{a.push(`${e}/**/*.${Nr[t].css}`),s.push(`${e}/**/*.${Nr[t].html}`),i.add("."+Nr[t].css),p.add("."+Nr[t].html)});Sr.filter([e+"/**/*.js"],{restore:!0});const o=Sr.filter([...s],{restore:!0}),c=Sr.filter([...a],{restore:!0}),l=Sr.filter(Rr.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json"],{base:r.resolve(Or,e),allowEmpty:!0,cwd:Or}).pipe(Sr.if("dev"===Er,Sr.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:Or},(function(e){Mr("处理"+e.relative+"......")})))).pipe(Sr.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");i.has(n.extname)&&(a=a.replace(s,"."+Ar.css)),p.has(n.extname)&&(a=a.replace(s,"."+Ar.html)),t.sync([a.replace(r.resolve(Or,e),r.resolve(Or,_r))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(o).pipe(Sr.rename((function(e){e.extname="."+Ar.html}))).pipe(o.restore).pipe(c).pipe(Sr.rename((function(e){e.extname="."+Ar.css}))).pipe(c.restore).pipe(l).pipe(Sr.replace(/[\s\S]*/,Tr(r.resolve(Or,_r)),{skipBinary:!1})).pipe(l.restore).pipe(n.dest(_r,{cwd:Or}))}));const{cwd:Lr,env:Br,targetPath:qr,subModePath:Fr,projectToSubPackageConfig:Jr,program:Wr,currentNamespace:Ir}=C,{tryAgain:Ur}=R;async function Kr(e){let t=r.resolve(Lr,Jr[Ir.mainMpPath],"app.js");await c.exists(t)||await c.outputFile(t,"App({});"),e()}n.task("mpWxSubMode",n.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(Wr.plugin||Wr.native)t();else{try{let e={packPath:(Jr.subPackagePath?"/":"")+Jr.subPackagePath,appMode:Jr.appMode};await c.outputFile(Fr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(n){return void await Ur(async()=>{await e(t)})}t()}}),function(){let e=[Kr,"subMode:createUniSubPackage","subMode:copyWxResource",...Wr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...Jr.mergePack?["watch:mainWeixinMpPackPath"]:[],...Fr===qr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return Wr.native&&(e=[Kr,"watch:mainAppJson","watch:native"]),"build"===Br?n.series.apply(this,e):n.parallel.apply(this,e)}(),(function(e){e(),"build"===Br&&process.exit()})));const{cwd:Dr,basePath:Hr,base:Yr,program:zr}=C;n.task("startToPackServe",n.series((async function(e){zr.native||await c.exists(Hr)||await c.mkdirs(Hr),e()}),"clean:base",(function(e){zr.native?e():n.watch(Yr+"/app.json",{events:["all"],cwd:Dr},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
